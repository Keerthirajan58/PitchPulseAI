# PitchPulse API Contract

*Version:* 1.0  
*Purpose:* Provide a single source of truth for the JSON payload shapes exchanged between the Flutter App (Prithvi), the FastAPI Backend (Roshini), and the AI Layer (Keerthi).

---

## 1. Authentication
**All client requests** must include the Firebase ID token in the header:
```http
Authorization: Bearer <firebase_id_token>
```
The Backend (`FastAPI`) verifies this token and extracts the `uid` to determine roles and workspace access.

---

## 2. Core Entities

### Player Object
```json
{
  "id": "uuid_string",
  "name": "Vinicius Jr",
  "position": "Winger",
  "nationality": "Brazil",
  "jersey_number": 7,
  "photo_url": "https://url.com/photo.jpg",
  "age": 24,
  "risk_score": 85,
  "risk_band": "HIGH", 
  "readiness_score": 35,
  "readiness_band": "LOW",
  "top_drivers": ["Sprint distance +25% vs baseline", "Low sleep quality"],
  "risk_sparkline": [40, 42, 45, 60, 75, 85]
}
```
*Note on Bands:* 
- `LOW`: 0-35
- `MED`: 36-65
- `HIGH`: 66-100

### Fixture Object
```json
{
  "id": "uuid_string",
  "home_team": "Real Madrid",
  "away_team": "Barcelona",
  "home_logo_url": "https://url.com/rm.png",
  "away_logo_url": "https://url.com/barca.png",
  "kickoff": "2026-03-15T20:00:00Z",
  "status": "NS", 
  "home_score": null,
  "away_score": null,
  "venue": "Santiago Bernabéu",
  "competition": "La Liga"
}
```
*Status Enums:* `"NS"` (Not Started), `"LIVE"`, `"FT"` (Full Time)

---

## 3. Endpoints (UI to Backend)

### `GET /me`
Resolves the current user's profile and routing details.
**Response:**
```json
{
  "uid": "firebase_uid",
  "email": "user@pitchpulse.io",
  "role": "admin", 
  "workspace_ids": ["workspace_uuid_1"],
  "display_name": "Coach Carlo"
}
```
*(Role is either `"admin"` or `"manager"`)*

### `GET /workspaces/{workspace_id}/home`
Populates the main Manager dashboard.
**Response:**
```json
{
  "next_fixture": { /* Fixture Object */ },
  "squad": [
    { /* Player Object 1 */ },
    { /* Player Object 2 */ }
  ]
}
```

### `GET /players/{player_id}/detail?weeks=6`
Returns the historical load data for charting.
**Response:**
```json
{
  "player": { /* Player Object */ },
  "weekly_load": [
    {
      "week_label": "Wk 42",
      "week_start": "2026-02-09T00:00:00Z",
      "acute_load": 1200,
      "chronic_load": 1100,
      "risk_score": 45
    }
  ],
  "risk_drivers": [
    {
      "label": "Acute:Chronic Workload Ratio",
      "value": "1.6",
      "threshold": "1.5",
      "trend": "UP",
      "severity": "HIGH"
    }
  ]
}
```

---

## 4. AI Feature Endpoints (Backend to AI / UI)

### `POST /players/{player_id}/action_plan`
Generates a deterministic plan for the coach. 
*Backend logic:* Fetch similar cases from Vector DB -> call `backend/ai/action_plan.py` -> return response.
**Response (Generated by Keerthi's AI Layer):**
```json
{
  "summary": "Vinicius Jr presents with elevated mechanical risk indicators.",
  "why": [
    "Sprint distance +25% vs baseline, exceeding club protocol."
  ],
  "recommendations": [
    "Limit Match Day -2 technical drills."
  ],
  "caution": "Closely monitor hamstring integrity.",
  "generated_at": "2026-02-21T10:00:00Z"
}
```

### `GET /players/{player_id}/similar_cases?k=5`
Retrieves similar historical injuries based on vector similarity.
**Response:**
```json
[
  {
    "player_id": "uuid",
    "player_name": "Hazard",
    "week_label": "Wk 12 (2023)",
    "similarity_score": 0.92,
    "summary": "Similar 25% sprint spike led to load accumulation.",
    "outcome": "Grade 1 hamstring strain sustained in the 68th minute."
  }
]
```

### `GET /workspaces/{workspace_id}/reports`
List of all match reports generated post-match.
**Response:**
```json
[
  {
    "fixture_id": "uuid",
    "opponent": "Barcelona",
    "match_date": "2026-02-20T20:00:00Z",
    "result": "W",
    "goals_for": 2,
    "goals_against": 1,
    "competition": "La Liga",
    "headline": "Real Madrid secured a 2-1 victory in a very high-intensity fixture." 
  }
]
```
*(Backend note: The `headline` field here should be populated from the `match_summary` key generated by Keerthi's `generate_match_report()` AI function.)*

### `POST /workspaces/{workspace_id}/suggested-xi`
Generates an AI-recommended formation and Starting XI.
**Request:**
```json
{
  "opponent": "Bayern Munich",
  "match_context": "Away, Champions League Semi-Final",
  "available_squad": [
    { "id": "uuid", "name": "Vinícius Jr", "position": "FW", "readiness": 95, "form": "Excellent" }
  ]
}
```
**Response:**
```json
{
  "best_formation": "4-3-3",
  "tactical_analysis": "AI Strategy: 4-3-3 selected to stretch Bayern's high line...",
  "starting_xi_ids": ["p1", "p2", "..."],
  "bench_ids": ["p12", "..."],
  "player_rationales": {
    "p1": "Vini is highly recommended to start. At 95% readiness..."
  }
}
```

### `POST /players/{player_id}/presage_checkin`
Submits selfie-captured vitals for readiness adjustment.
**Request:**
```json
{
  "vitals": {
    "pulse_rate": 74,
    "hrv_ms": 42,
    "breathing_rate": 18,
    "stress_level": "High",
    "focus": "Low",
    "valence": "Negative",
    "confidence": 0.88
  }
}
```
**Response:**
```json
{
  "readiness_delta": -17,
  "readiness_flag": "ALERT",
  "emotional_state": "Stressed",
  "contributing_factors": [
    "Resting HR elevated +20bpm above baseline.",
    "HRV suppressed at 52% of baseline.",
    "High psychological stress indicators detected in facial scan.",
    "Negative emotional valence detected..."
  ],
  "recommendation": "Reduce training load by 20% and prioritize mental recovery."
}
```

### `POST /players/{player_id}/movement_analysis`
Submits a video for biomechanical risk analysis.
**Request:** Multipart form data with `video` file.
**Response:**
```json
{
  "mechanical_risk_band": "HIGH",
  "flags": ["Knee Valgus", "Forward Trunk Lean"],
  "coaching_cues": ["Drive knees out...", "Cue upright chest..."],
  "confidence": 0.85
}
```

